import { RESTManagerInstance } from "@client/api/rest";
import { useAPI } from "@client/context/API";
import { ConnectToExploitServerRequest } from "@shared/api";
import { WEBSOCKET_ENDPOINTS } from "@shared/endpoints";
import { useRef, useState } from "react";
import { SubmitHandler, useForm } from "react-hook-form";
import toast from "react-hot-toast";
import { BiSolidServer } from "react-icons/bi";

export const ExploitServer: React.FC = () => {
  const { featuresConfig } = useAPI();
  const socketRef = useRef<WebSocket | null>(null);

  const [serverLogs, setServerLogs] = useState<string[]>([]);
  const {
    register,
    handleSubmit,
    formState: { errors },
  } = useForm<ConnectToExploitServerRequest>();

  const connectToExploitServer: SubmitHandler<ConnectToExploitServerRequest> = async data => {
    if (!data.teamToken) {
      return;
    }
    try {
      const isHttps = typeof window !== "undefined" && window.location.protocol === "https:";
      const prefix = isHttps ? "wss" : "ws";
      const suffix = featuresConfig.basePath.length > 0 ? featuresConfig.basePath : "";
      const wsBaseUrl = `${prefix}://${window.location.host}${suffix}`;
      const socket = new WebSocket(`${wsBaseUrl}${WEBSOCKET_ENDPOINTS.EXPLOIT_SERVER}?teamToken=${data.teamToken}`);
      socketRef.current = socket;

      // When data comes from backend, write to terminal
      socket.addEventListener("message", event => {
        setServerLogs(prev => [...prev, event.data]);
      });

      socket.addEventListener("open", () => {
        console.log("open");
      });

      socket.addEventListener("close", () => {
        console.log("close");
      });
    } catch (e) {
      console.error(e);
      toast.error("Error while connecting to exploit server");
    }
  };

  return (
    <div className="w-full flex flex-col gap-2">
      <div className="flex gap-2 items-center mb-2">
        <BiSolidServer size={32} />
        <h1 className="text-2xl font-semibold select-none">Exploit Server</h1>
      </div>
      <div className="card bg-base-300 border border-base-300">
        <div className="card-body p-4">
          <p className="text-info">
            The exploit server provides your team a way to visualize network interactions. This is crucial for
            challenges where the flag can be exfiltrated via a network request.
            <br /> In order to reduce the space used on the disk the interactions <b>are not stored</b>. Therefore we
            suggest you to <b>keep this page open</b>.
          </p>
          <p className="text-info">
            You will be able to visualize all the network interactions made to <code>/exploit/&lt;teamToken&gt;</code>.
            Type your <i>team token</i> and click on <i>Connect</i> to start.
          </p>
          <div className="flex gap-2 mt-4">
            <form onSubmit={handleSubmit(connectToExploitServer)} className="flex flex-1 gap-4 space-y-4">
              <input
                type="text"
                placeholder="Your Team Token"
                className="input input-bordered w-full"
                {...register("teamToken", { required: true })}
              />

              {/* Submit */}
              <div className="flex justify-end">
                <input className="btn btn-primary" type="submit" value="Connect" />
              </div>
            </form>
          </div>
          {errors.teamToken && <p className="text-error text-sm">Team Token is required.</p>}
          <div className="code-mockup hide-before">
            <pre className="text-accent text-wrap wrap-break-word break-all">
              <code>
                {serverLogs.map(s => (
                  <pre>{s}</pre>
                ))}
              </code>
            </pre>
          </div>
        </div>
      </div>
    </div>
  );
};
