import { WebSocketServer, WebSocket } from "ws";
import { parse } from "url";
import { ManagerSingleton } from "@server/manager";
import Logger from "@shared/logger";
import { IncomingMessage } from "http";

export const setupExploitTerminalWss = (wssExploitServer: WebSocketServer) => {
  const singleton = ManagerSingleton.getInstance();
  const wsExploitServerSessions = singleton.wsExploitServerSessions;

  wssExploitServer.on("connection", async (ws: WebSocket, request: IncomingMessage) => {
    try {
      const { query } = parse(request.url ?? "", true);
      const teamToken = query.teamToken as string;

      if (!singleton.isTeamTokenValid(teamToken)) {
        throw new Error("Invalid Team Token");
      }

      wsExploitServerSessions.set(ws, { teamToken });
      Logger.debug(`User connected with team token ${teamToken}`);

      ws.on("close", async () => {
        Logger.info("Exploit Server client disconnected");
        wsExploitServerSessions.delete(ws);
      });
    } catch (err) {
      Logger.error(`Error initializing session: ${err}`);
      ws.send(`${err}`);
      ws.close();
    }
  });
};
